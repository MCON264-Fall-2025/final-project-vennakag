name: Autograding Tests

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  autograde:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Copy instructor tests
        run: |
          mkdir -p src/test/java/edu/course/eventplanner
          cp .github/tests/*.java src/test/java/edu/course/eventplanner/

      # --- Individual graders (these create the runner outputs the reporter needs) ---
      - name: Venue Selection Tests
        id: venue-selection-tests
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "Venue Selection Tests"
          setup-command: ""
          command: "mvn -B -ntp test -Dtest=VenueSelectionTest"
          timeout: 10
          max-score: 20

      - name: Guest Management Tests
        id: guest-management-tests
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "Guest Management Tests"
          setup-command: ""
          command: "mvn -B -ntp test -Dtest=GuestManagementTest"
          timeout: 10
          max-score: 20

      - name: Seating Algorithm Tests
        id: seating-algorithm-tests
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "Seating Algorithm Tests"
          setup-command: ""
          command: "mvn -B -ntp test -Dtest=SeatingAlgorithmTest"
          timeout: 10
          max-score: 20

      - name: Task Workflow and Undo Tests
        id: task-workflow-and-undo-tests
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "Task Workflow and Undo Tests"
          setup-command: ""
          command: "mvn -B -ntp test -Dtest=TaskWorkflowTest"
          timeout: 10
          max-score: 20

      - name: Student Unit Tests Coverage
        id: student-unit-tests-coverage
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "Student Unit Tests Coverage"
          setup-command: ""
          command: "mvn -B -ntp test jacoco:report && python3 .github/scripts/check_coverage.py"
          timeout: 15
          max-score: 15

      - name: README Documentation
        id: readme-documentation
        uses: classroom-resources/autograding-command-grader@v1
        with:
          test-name: "README Documentation"
          setup-command: ""
          command: "python3 .github/scripts/check_readme.py"
          timeout: 5
          max-score: 5

      # --- Reporter (this is what syncs grades to Classroom) ---
      - name: Autograding Reporter
        if: always()
        uses: classroom-resources/autograding-grading-reporter@v1
        env:
          VENUE-SELECTION-TESTS_RESULTS: "${{ steps.venue-selection-tests.outputs.result }}"
          GUEST-MANAGEMENT-TESTS_RESULTS: "${{ steps.guest-management-tests.outputs.result }}"
          SEATING-ALGORITHM-TESTS_RESULTS: "${{ steps.seating-algorithm-tests.outputs.result }}"
          TASK-WORKFLOW-AND-UNDO-TESTS_RESULTS: "${{ steps.task-workflow-and-undo-tests.outputs.result }}"
          STUDENT-UNIT-TESTS-COVERAGE_RESULTS: "${{ steps.student-unit-tests-coverage.outputs.result }}"
          README-DOCUMENTATION_RESULTS: "${{ steps.readme-documentation.outputs.result }}"
        with:
          runners: venue-selection-tests,guest-management-tests,seating-algorithm-tests,task-workflow-and-undo-tests,student-unit-tests-coverage,readme-documentation
